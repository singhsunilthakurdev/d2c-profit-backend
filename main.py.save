login: Fri Feb 27 17:07:52 on ttys000
sunil@Sunilss-MacBook-Pro ~ % cd ~/influencer-analyzer/backend
sunil@Sunilss-MacBook-Pro backend % is
zsh: command not found: is
sunil@Sunilss-MacBook-Pro backend % cd backend
cd: no such file or directory: backend
sunil@Sunilss-MacBook-Pro backend % 

% cd ~/influencer-analyzer/backen^^^^^^^^^^^^^^^from fastapi import FastAPI, Request
from pydantic import BaseModel
import stripe
import psycopg2
import os
import hashlib

app = FastAPI()

stripe.api_key = os.getenv("STRIPE_SECRET_KEY")
WEBHOOK_SECRET = os.getenv("STRIPE_WEBHOOK_SECRET")
DATABASE_URL = os.getenv("DATABASE_URL")


def get_connection():
    return psycopg2.connect(DATABASE_URL)


def hash_password(password):
    return hashlib.sha256(password.encode()).hexdigest()


# -----------------------
# REGISTER
# -----------------------
class RegisterModel(BaseModel):
    email: str
    password: str


@app.post("/register")
def register_user(data: RegisterModel):
    conn = get_connection()
    cur = conn.cursor()

    hashed = hash_password(data.password)

    try:
        cur.execute("""
            INSERT INTO users (email, password)
            VALUES (%s, %s)
        """, (data.email, hashed))
        conn.commit()
    except:
        return {"error": "User already exists"}

    cur.close()
    conn.close()

    return {"status": "registered"}


# -----------------------
# LOGIN
# -----------------------
class LoginModel(BaseModel):
    email: str
    password: str


@app.post("/login")
def login_user(data: LoginModel):
    conn = get_connection()
    cur = conn.cursor()

    hashed = hash_password(data.password)

    cur.execute("""
        SELECT subscription_status FROM users
        WHERE email=%s AND password=%s
    """, (data.email, hashed))

    result = cur.fetchone()

    cur.close()
    conn.close()

    if result:
        return {"login": True, "subscription": result[0]}

    return {"login": False}


# -----------------------
# STRIPE WEBHOOK
# -----------------------
@app.post("/webhook")
async def stripe_webhook(request: Request):
    payload = await request.body()
    sig_header = request.headers.get("stripe-signature")

    try:
        event = stripe.Webhook.construct_event(
            payload, sig_header, WEBHOOK_SECRET
        )
    except Exception as e:
        return {"error": str(e)}

    if event["type"] == "checkout.session.completed":
        session = event["data"]["object"]
        email = session["customer_details"]["email"]

        conn = get_connection()
        cur = conn.cursor()

        cur.execute("""
            UPDATE users
            SET subscription_status='active'
            WHERE email=%s
        """, (email,))

        conn.commit()
        cur.close()
        conn.close()

    return {"status": "success"}
